# ZetaDAO 社区门户阶段性进展与成果汇报（截至 2025-11-07）

> 本报告用于向需求方/拨款方汇报当前阶段完成的工作成果、技术实现、创新亮点与后续规划。仓库：`ZetaDAO/nextjs-app`。

## 一、总体概述

- 交付对象：面向 ZetaChain 社区的内容与电商一体化门户（投稿/审核/发布 + 商店链上支付与状态同步）。
- 技术栈：Next.js 14（App Router）+ TypeScript + Tailwind + Supabase + wagmi/viem + RainbowKit。
- 安全基线：最小信任面、httpOnly Cookie 鉴权、事件级链上验真、RLS（行级安全）与严格输入校验。

## 二、已完成功能模块

1) 内容与社区模块
- 投稿系统：文章/视频/活动投稿，支持富文本与元数据标签。
- 审核面板：按状态筛选（pending/approved/rejected）、分类管理 CRUD、批准/拒绝含审计日志。
- 发布与浏览：已批准内容自动发布，文章/视频列表与详情页完善。
- 社交整合：用户资料、关注/粉丝统计、每日签到 XP 体系。

2) 商店（Shop）模块
- 商品管理（Admin）：创建/编辑/上下架/删除、CSV 导出订单。
- 下单与支付（用户）：创建订单 → 链上 createOrder → 日志解析回填 onchainId → payOrder → 交易回执核验 → DB 确认。
- 订单状态同步（Admin）：发货/完成/取消/退款四类动作，客户端强制切链，服务端解码 OrderStatusChanged 事件后才持久化。
- 浏览器链接：所有 Tx 链接自动指向当前环境（测试网/主网）的区块浏览器。

3) 账户与鉴权模块
- 账号体系：NextAuth（邮箱注册登录、Google 登录）、会话与 XP。
- 管理员鉴权（创新性解耦）：
  - 登录 与 钱包连接 完全解耦，支持“仅登录”、“仅连钱包”、“两者兼有”，互不依赖。
  - 通过“签名挑战 → 服务器校验 → 设置 httpOnly Cookie（connected_wallet）”实现管理员识别，前端不再携带或信任自定义请求头，杜绝伪造。
  - Admin 白名单集中在 `ADMIN_WALLETS` 环境变量，动态可配。
- 钱包连接体验：MetaMask / OKX（注入）/ WalletConnect；统一链切换逻辑与错误反馈。

4) 链网与配置模块
- 集中化链配置：`lib/web3.ts` 单一事实源（链 ID、RPC、Explorer 基址），前后端共享。
- 强制目标网络：所有涉及写交易的页面会在客户端请求前提示/尝试切换到目标 ZetaChain。
- 服务器侧使用集中化 RPC/链配置创建 viem client，保证与客户端一致，避免环境漂移。

## 三、关键改造与安全强化

- 创新性解耦设计（登录 ≠ 钱包）：
  - 传统 DApp 常将登录与钱包强绑定，易引发 UX 与安全折衷。本项目将二者彻底分离，登录用于账号域（内容、社交、XP），钱包仅用于链上域（签名、交易）。
  - 管理员权限由钱包签名+Cookie 授予，服务端校验，客户端无权伪造，避免“自定义请求头冒充管理员”等风险。

- 服务端事件级验真：
  - 对订单创建/支付/状态变更，均以链上事件为准；必须在回执日志中匹配到对应事件与参数（orderId、status、metadataHash）才更新数据库。

- 单一链配置与网络强制：
  - 通过 `NEXT_PUBLIC_ZETA_CHAIN_ID / NEXT_PUBLIC_ZETA_RPC_URL / NEXT_PUBLIC_ZETA_EXPLORER_BASE` 参数化主网/测试网。
  - 客户端所有写操作前先进行切链，减少失败率与资产风险。

## 四、近期交付清单（本阶段新增/改进）

- 新增：集中化链配置 `lib/web3.ts`。
- 新增：独立“连接钱包并验证”流程（Header），签名挑战 + httpOnly Cookie。
- 新增：网络状态徽标（桌面/移动端），不匹配一键切换。
- 新增：商店购买弹窗的网络提示与一键切换。
- 改造：Admin 全链路切换为 Cookie 基于的管理员校验（`isAdminFromRequest`）。
- 改造：商店三条关键 API（link/confirm/status）均采用服务器侧事件验真与集中链配置。
- 文档：README/SUMMARY 补充链网配置、Cookie 鉴权、WalletConnect projectId。
- 可靠性：修复 Header 初次水合的文本不一致问题（SSR → CSR 占位渲染）。

## 五、可衡量收益（拨款评估角度）

- 安全性提升：
  - 管理员鉴权全面移至服务端，杜绝前端伪造；链上写操作与后端状态变更通过事件验真，避免越权/错写。
- 体验优化：
  - 登录与钱包解耦，降低用户门槛；自动切链与显式提示减少误操作；OKX 注入支持覆盖更多终端。
- 可运维性：
  - `lib/web3.ts` 集中配置，让主网/测试网/Explorer 切换“零代码”化；.env 参数与文档到位。

## 六、下一阶段规划（可作为里程碑）

- A. 管理后台提示与诊断：在 /admin 顶部提供环境、Cookie、白名单自检小组件（初版已上线）。
- B. 测试与监控：
  - 增加关键路径集成测试（下单→支付→确认；管理员状态变更）。
  - 针对签名/切链失败场景的端到端测试用例。
- C. 数据与风控：
  - 订单导出格式扩展与对账脚本（支持含税、物流字段）。
  - 失败交易回溯标注与重试流程。
- D. 性能与可用性：
  - 列表分页与懒加载；错误率与延迟的指标采集（可对接 Sentry/Logflare）。

## 七、部署与运维指引（摘要）

- 环境变量：
  - `ADMIN_WALLETS=0xabc...,0xdef...`
  - `NEXT_PUBLIC_ZETA_CHAIN_ID=7001 | 7000`
  - `NEXT_PUBLIC_ZETA_RPC_URL=...`
  - `NEXT_PUBLIC_ZETA_EXPLORER_BASE=...`（可选）
  - `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID=...`
- 必要动作：
  - 修改 .env 后需重启服务；管理员首次访问需完成“连接钱包→切链→签名”以设置 Cookie。

## 八、结语

通过“创新性登录/钱包解耦 + 服务器签名 Cookie 管理员鉴权 + 链上事件级验真 + 单一链配置”的组合拳，我们在安全性、可维护性与用户体验上实现了显著跃升，也为后续扩展（多网络、更多钱包、更多业务）奠定了坚实基础。上述成果已实装并在开发环境验证，具备投入试运行条件。
